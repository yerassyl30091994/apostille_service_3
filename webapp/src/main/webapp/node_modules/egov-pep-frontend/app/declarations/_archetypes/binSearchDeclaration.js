angular.module("app").controller('binSearchDeclarationController', ['$scope', '$http', '$injector', '$rootScope', '$declaration', '$uin', '$session', '$q', '$router',
    function ($scope, $http, $injector, $rootScope, $declaration, $uin, $session, $q, $router) {
        $declaration.onLoaded(function () {
            //инициализация заявки
            $declaration.init(
                $router.getActiveLocation().get.context,
                //модель данных заявки
                {
                    "data": {
                        //знаком @ помечены поля модели которые должны сохранятся в ссылке
                        //это могут быть строки, числа и булевы значения
                        //обращение к таким полям выполняется без @
                        '@declarantUin': '',
                        '@bin': ''
                    }
                }
            );

            //определяет что делать при переходе на шаг sign
            $declaration.onStep('sign', function () {
                $declaration.signByIndividual(function () {
                    var defer = $q.defer();
                    defer.resolve();
                    return defer.promise;
                });
            });

            //определяет что делать при переходе на шаг status
            $declaration.onStep('status', function(){
                $declaration.getCurrentState();
            });

            //определяет как проверять доступен ли шаг search
            $declaration.allowStep('search', function(){
                return !$declaration.requestId;//если заявка не было оформлена, шаг доступен
            });

            //определяет как проверять доступен ли шаг sign
            $declaration.allowStep('sign', function(){
                return !$declaration.requestId && //если заявка не было оформлена И
                    $declaration.model.data.bin && //если в модели заявки есть валидный и существующий бин И
                    ($session.operator && $declaration.model.data.declarantUin || !$session.operator); //если оператор цон указал декларанта или это не оператор цон
            });

            //определяет как проверять доступен ли шаг status
            $declaration.allowStep('status', function(){
                return !!$declaration.requestId;//если заявка была оформлена
            });
        });

    }]);