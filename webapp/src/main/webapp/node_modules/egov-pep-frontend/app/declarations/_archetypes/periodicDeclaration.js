angular.module("app").controller('periodicDeclaration', ['$scope', '$http', '$injector', '$rootScope', '$declaration', '$session', '$q', '$router',
    function ($scope, $http, $injector, $rootScope, $declaration, $session, $q, $router) {

        $declaration.onLoaded(function () {

            $declaration.init($router.getActiveLocation().get.context, {
                data: {
                    declarantUin: "",
                    startDate: moment().subtract(6, 'months').toDate(),
                    endDate: moment().toDate(),
                    selectedPeriod: true
                }, availableFL: false
            });

            $declaration.onStep('sign', function () {

                //заявка доступна только для физлиц
                $declaration.signByIndividual(function () {
                    var defer = $q.defer();
                    defer.resolve();
                    return defer.promise;
                });
            });

            $declaration.onStep('status', function () {
                $declaration.getCurrentState();
            });

            $declaration.allowStep('search', function () {
                return !$declaration.requestId;
            });

            $declaration.allowStep('sign', function () {
                var now = moment();

                if (moment($declaration.model.data.startDate).isBefore(now) &&
                    moment($declaration.model.data.endDate).isBefore(now) &&
                    moment($declaration.model.data.startDate).isBefore(moment($declaration.model.data.endDate))
                ) {
                    var isValidDateRange = true;
                }

                return !$declaration.requestId &&
                    isValidDateRange &&
                    ($session.operator && $declaration.model.data.declarantUin || !$session.operator);
            });

            $declaration.allowStep('status', function () {
                return !!$declaration.requestId;
            });


        });
    }]);