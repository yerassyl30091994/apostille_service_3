angular.module("app").service('$egovChoiceSignService', ['$http', '$declaration', '$rootScope', '$error',
    function($http, $declaration, $rootScope, $error) {
        $rootScope.$egovChoiceSignService = this;
        this.vTypes = { //инициализация объектов, все способы подписания не доступны
            byOTP: {
                available: false, //не доступен
                show: false, //не показываем
                registered: false
            },
            byEDS: {
                available: false, //не доступен
                show: false, //не показываем
                registered: true
            },
            byMobEDS: {
                available: false, //не доступен
                show: false, //не показываем
                registered: false
            },
            byBIO: {
                available: false, //не доступен
                show: false, //не показываем
                registered: false
            },
            choiceSign: {
                show:false
            }
        };
        this.componentVerificationTypes = true;
        this.backButtonHide = true; //кнопка назад спрятан
        this.signByOTP = function() { //подписание СМС-кой
            this.vTypes.choiceSign = {
                show: false //не показываем // true - показываем/ false -не показываем выбор способов подписания
            };
            this.vTypes.byOTP.show = true; //даем доступ на подписание по СМС
            this.backButtonHide = false; //кнопка назад доступен
        };

        this.signByEDS = function() { //подписание по ЭЦП
            this.vTypes.choiceSign = {
                show: false //не показываем // true - показываем/ false -не показываем выбор способов подписания
            };
            this.vTypes.byEDS.show = true; //даем доступ на подписание по ЭЦП
            this.backButtonHide = false; //кнопка назад доступен
        };

        this.signByMobEDS = function() { //подписание по МЭЦП
            this.vTypes.choiceSign = {
                show: false //не показываем // true - показываем/ false -не показываем выбор способов подписания
            };
            this.vTypes.byMobEDS.show = true; //даем доступ на подписание по МЭЦП
            this.backButtonHide = false; //кнопка назад доступен
        };

        this.signByBIO = function() { //подписание с БИО
            this.vTypes.choiceSign = {
                show: false //не показываем // true - показываем/ false -не показываем выбор способов подписания
            };
            this.vTypes.byBIO.show = true; //даем доступ на подписание по БИО
            this.backButtonHide = false; //кнопка назад доступен
        };

        this.otpCb = function(rid) { //callback по ОТП, получаем requestId и переходим на статус
            $declaration.requestId = rid;
            $declaration.goStep('status');
        };

        this.msignCb = function(rid) { //callback по МЭЦП, получаем requestId и переходим на статус
            $declaration.requestId = rid;
            $declaration.goStep('status');
        };

        this.back = function() { // кнопка назад для возврата на шаг выбора подписания
            this.vTypes.choiceSign = {
                show: true // true - показываем/ false -не показываем выбор способов подписания
            };
            this.backButtonHide = true; //кнопка назад спрятан
            this.vTypes.byOTP.show = false; //не показываем подписание по ОТП
            this.vTypes.byEDS.show = false; //не показываем подписание по ЭЦП
            this.vTypes.byMobEDS.show = false; //не показываем подписание по МЭЦП
            this.vTypes.byBIO.show = false; //не показываем подписание по БИО
        };

        this.checkAvailable = function(rs){ //функция проверки доступности выбора способа подписания по данным из реста app/verification-types
            /*Проверяем какие способы доступны и показываем эти кнопки, если доступен только один вид подписания, то сразу запускаем его без выбора*/
            var lnt = !!(rs.verificationTypes.length>1),
                vType = [],
                reg = {},
                isPod = ($declaration.UI() === "POD");   // проверяем на ПОД, если ПОД то все типы подписания доступны

            rs.verificationTypes.forEach(function (value){
                vType.push(value.verificationType);
                reg[value.verificationType] = value.registered;
            });
            this.vTypes.choiceSign = {
                show: lnt
            }
            this.vTypes.byOTP = {
                available: vType.indexOf("OTP")!==-1, //определеяется доступность подписания по ОТП
                show: (!lnt && vType.indexOf("OTP")!==-1), //показываем или не показываем
                registered: reg["OTP"] || !!isPod //показываем сообщение об отказе в подписании данным методом либо разрешаем
            };
            this.vTypes.byEDS = {
                available: vType.indexOf("EDS")!==-1, //определеяется доступность подписания по ЭЦП
                show: (!lnt && vType.indexOf("EDS")!==-1), //показываем или не показываем
                registered: true  //показываем сообщение об отказе в подписании данным методом либо разрешаем
            };
            this.vTypes.byMobEDS = {
                available: vType.indexOf("M_EDS")!==-1, //определеяется доступность подписания по МЭЦП
                show: (!lnt && vType.indexOf("M_EDS")!==-1), //показываем или не показываем
                registered: reg["M_EDS"] || !!isPod //показываем сообщение об отказе в подписании данным методом либо разрешаем
            };
            this.vTypes.byBIO = {
                available: (vType.indexOf("BIO")!==-1 && hasConnect), //определеяется доступность подписания по БИО
                show: (!lnt && vType.indexOf("BIO")!==-1 && hasConnect), //показываем или не показываем
                registered: reg["BIO"] || !!isPod //показываем сообщение об отказе в подписании данным методом либо разрешаем
            };
        };

        return this;
    }
]);
