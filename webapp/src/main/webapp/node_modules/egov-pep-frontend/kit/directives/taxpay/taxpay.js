angular.module("app").directive('taxpay', ['$dictionary', '$declaration', '$modal', '$http', '$locales', '$rootScope',
    function ($dictionary, $declaration, $modal, $http, $locales, $rootScope) {

        function getYearsList() {
            var currentYear = new Date().getFullYear();
            var years = {};
            var startYear = currentYear;
            var id = 0;
            while (startYear > currentYear - 10) {
                years[id] = startYear.toString();
                startYear--;
                id ++;
            }
            return years;
        }

        return {
            scope: {
                showTerm: "@showterm",
                department: "=",
                period: "=",
                amount: "=",
                justread: "@"
            },
            templateUrl: 'kit/directives/taxpay/taxpay.html',
            replace: true,
            restrict: 'E',
            transclude: true,
            link: function (scope) {

                scope.$modal = $modal;

                scope.viewModel = {
                    taxComponent: null,
                    taxComponentClone: {
                        id: null,
                        name:{
                            full: null
                        }
                    },
                    taxperiod: null,
                    years: getYearsList()
                };

                scope.modalShow = function(name){
                    $modal.show(name);
                    if(scope.viewModel.taxComponentClone.name.full){
                        scope.viewModel.taxComponent.name.full = scope.viewModel.taxComponentClone.name.full;
                        scope.viewModel.taxComponent.id = scope.viewModel.taxComponentClone.id;
                    }
                };
                $modal.onClose = function(){
                    if(scope.viewModel.taxComponent.selectIsAvailable){

                        scope.viewModel.taxComponentClone.name.full = scope.viewModel.taxComponent.name.full;
                        scope.viewModel.taxComponentClone.id = scope.viewModel.taxComponent.id;

                        scope.viewModel.taxComponent.name.full = scope.viewModel.taxComponent.id= null;
                        scope.viewModel.taxComponent.selectIsAvailable = true;
                    }else{
                        scope.viewModel.taxComponent.name.full = scope.viewModel.taxComponent.id= null;
                        scope.viewModel.taxComponent.selectIsAvailable = false;
                    }
                };


                $declaration.model.taxPeriod = null;

                scope.$watch('viewModel.amount', function (newVal, oldVal) {
                    $declaration.model.amount = newVal;
                });

                scope.$watch('viewModel.taxComponent.id', function (newVal, oldVal) {
                    $declaration.model.taxDepartmentId = newVal;
                });

                scope.$watch('viewModel.taxperiod', function (newVal, oldVal) {
                    $declaration.model.taxperiod = scope.viewModel.years[newVal];
                });
            }

        }
    }]).controller(function ($scope) {

});