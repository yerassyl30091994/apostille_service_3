app
    .directive("declaration", ['$declaration', '$session', '$settings', function ($declaration, $session, $settings) {
        return {
            scope: false,
            restrict: "E",
            transclude: true,
            replace: false,
            templateUrl: "kit/directives/declaration/declaration.html",

            controller: function ($scope) {
                if ($settings.isPep()) {
                    var _isApproval = function (a) {
                        return (!!a.approvals) ? (a.approvals.filter(_isApproval).length > 0)
                            : !!$session && (a.uin === $session.uin);
                    };
                    $scope.header = {
                        isOperator: function () {
                            return !!$session.operator;
                        },
                        isUL: function () {
                            return !!$session.organization;
                        },
                        isFL: function () {
                            return !!$session.individual && !$session.operator;
                        },
                        isDeclarant: function () {
                            return $scope.header.isFL() && (!$declaration.state ||
                                (!!$declaration.state.declarantIdentificationNumber &&
                                    ($declaration.state.declarantIdentificationNumber === $session.uin)));
                        },
                        isApproval: function () {
                            return $scope.header.isFL() && !!$declaration.state && (
                                    (
                                        !!$declaration.state.approvalProcessInfos &&
                                        ($declaration.state.approvalProcessInfos.filter(_isApproval).length > 0)
                                    ) || (
                                        !!$declaration.state.approvals
                                        && ($declaration.state.approvals.filter(_isApproval).length > 0)
                                    )
                                );
                        },
                        getCurrentRole: function () {
                            return (!$session || !$session.uin) ? 'UNKNOWN'
                                : $scope.header.isOperator() ? 'OPERATOR'
                                : $scope.header.isUL() ? 'UL'
                                : $scope.header.isDeclarant() ? 'DECLARANT'
                                : $scope.header.isApproval() ? 'APPROVAL'
                                : 'FL';
                        }
                    };
                }
            },

            link: function (scope, element, attrs) {}
        }
    }]);