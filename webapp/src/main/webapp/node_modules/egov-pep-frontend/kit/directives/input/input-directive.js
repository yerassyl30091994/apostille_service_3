angular.module("app").directive("input", ["$parse", "$rootScope", function ($parse, $rootScope) {

    var inputControllers = [];

    return {
        restrict: "E",
        replace: false,
        scope: false,
        require: "?ngModel",
        link: function (scope, element, attrs, controller) {

            element.addClass('monospace');
            element.focus(function () {
              //  if( $keyboard.isEnabled() ){
               //     $keyboard.open(element, controller, scope);
                    element.addClass('focus');
                    scope.$apply();
              //  }
            });
            element.blur(function(){
             //   if( $keyboard.isEnabled() ){
                    element.removeClass('focus');
                    scope.$apply();
              //  }
            });
            element.data('ngModelController', controller);

            if( attrs.controller && controller){
                $parse(attrs.controller).assign(scope.$parent, controller);
            }

            if( controller ){
                inputControllers.push(controller);
            }

            $rootScope.resetInputs = $rootScope.resetInputs || function(){
                _.each(inputControllers, function(inputController){
                    inputController.$setPristine();
                });
            };

            scope.$watch(function() { return element.is(':hidden') }, function() {
                controller && controller.$viewValue == "" && controller.$setPristine();
            });

            $rootScope.$watch('$router.pendingRequests', function(value){
                if( value > 0 && element.is(':focus')){
                    setTimeout(function(){element.blur()});
                }
            });
        }
    }
}]);