angular.module("app").service('$egovMEds', ['$http', '$declaration', '$rootScope', '$error',
    function ($http, $declaration, $rootScope, $error) {
        $rootScope.$egovMEds = this;
        this.cert = {
            serialNumber: null,
            phoneNumber: null,
            hiddenNumber: null
        };
        this.choicePhone = true; //По этой переменной определяем доступен блок выбора телефона, по умолчанию доступен
        this.errorMessage = false; //По этой переменной показываем сообщение что у пользователя не зарегистрировано МЭЦП, по умолчанию не показываем
        this.getPhones = function (iin) {
            $http.get("rest/msign/user-phones?uin=" + iin).success(function (data) { //запрос телефон номеров и сертификатов
                if (data.phones.length >= 1) { //Если есть список телефонов, значить у пользователя зарегистрировано МЭЦП
                    $rootScope.$egovMEds.iin = iin // для ПОДа
                    $rootScope.$egovMEds.choicePhone = true; //Блок выбора телефона доступен
                    $rootScope.$egovMEds.errorMessage = false; //Не показываем сообщение что у пользователя не зарегистрировано МЭЦП
                    $rootScope.$egovMEds.phones = $rootScope.$egovMEds.hidePhone(data.phones);
                    if (data.phones.length == 1) { //Если количество номеров один
                        if (data.phones[0].certificates.length == 1) { //И в нем количество сертификатов один
                            $rootScope.$egovMEds.cert.serialNumber = data.phones[0].certificates[0].subject.certificateSerialNumberStr; //То номер сертификата ставим сразу
                            $rootScope.$egovMEds.cert.phoneNumber = data.phones[0].phone_number; //И номер телефона делаем выбранным по умолчанию
                            $rootScope.$egovMEds.cert.hiddenNumber = "*******" + data.phones[0].phone_number.substr(data.phones[0].phone_number.length - 4, 4); //Для показа на ПОДе
                        }
                    }
                } else { //Если пустой массив значит у пользователя не зарегистрировано МЭЦП
                    $rootScope.$egovMEds.choicePhone = false; //Блок выбора телефона не доступен
                    $rootScope.$egovMEds.errorMessage = true; //Показываем сообщение что у пользователя не зарегистрировано МЭЦП
                }
            }).error(function () {
                $error.setError('TECH_ERROR');
            });
        };

        this.hidePhone = function (val) { // Для ПОДа прячем номер телефона и показываем только последние 4 номера
            var obj = [];
            angular.forEach(val, function (el) { //Перебираем каждый элемент
                var phone = "*******" + el.phone_number.substr(el.phone_number.length - 4, 4); //Начальные семь цифр делаем звездочкой и показываем последние 4
                obj.push({ //собираем в массив
                    "certificates": el.certificates, //значение сертификата такой же
                    "hidden_number": phone, //добавляем еще один объект для преобразованного номера
                    "phone_number": el.phone_number //телефон номера ложим рядом для отправки в send-msign
                });
            });
            return obj; //возвращаем преобразованный массив
        };

        return this;
    }
]);
