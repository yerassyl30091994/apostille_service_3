angular.module("app").directive('egovMEds', [function () {
    return {
        scope: {
            data: "=", //принимает все заполенные данные для отправки в ГО
            callback: "=" //возвращает requestId
        },
        replace: true,
        templateUrl: 'kit/directives/sign/m-eds/template.html',
        restrict: "E",
        controller: function ($scope, $declaration, $http, $egovChoiceSignService, $error, $session, $egovMEds) {

            $scope.$egovMEds = $egovMEds; //получить данные сервиса в контроллер
            $scope.isPOD = false; //По этой переменной определяем доступно ли ввод ИИН или нет, по умолчанию он не доступен

            if ($declaration.UI() === "POD") { //Если услугу получают на ПОДе, то пользователь вводит ИИН
                $scope.isPOD = true; //Мы на ПОДе, поэтому ввод ИИН доступен
                $egovMEds.choicePhone = false; //Блок выбора телефона не доступен
                $egovMEds.errorMessage = false; //Не показываем сообщение что у пользователя не зарегистрировано МЭЦП
            } else if ($declaration.UI() === "PORTAL") {//Если услугу получают на ПЭПе, то ИИН берем из сессий
                $egovChoiceSignService.getPhones = function () { //вызов этой функции происходит в директиве choice-sign
                    // на кнопке выбора подписания по МЭЦП
                    $egovMEds.getPhones($session.uin);
                };
            }
            $scope.sendMobEds = function (iin) { //вызываем по кнопке Использовать номер. Это отправка заявки в ГО.
                var url = "rest/app/send-msign?serialNumber=" + $egovMEds.cert.serialNumber + "&phoneNumber=" + $egovMEds.cert.phoneNumber;
                // для ПОДа добавляем ИИН
                if ($scope.isPOD) {
                    url += '&uin=' + iin;
                }
                $http.post(url, $scope.data).success(function (rid) {
                    $scope.callback(rid.requestNumber);
                }).error(function () {
                    $error.setError('TECH_ERROR');
                });
            };
        },
        link: function (scope, elem, attrs) {
        }
    };
}]);
