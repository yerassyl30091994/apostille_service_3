angular.module("app").directive("enterOtp", ['$http', '$error', '$declaration', function ($http, $error, $declaration) {
    return {
        restrict: "E",
        scope: {
            data: "=" //модель для создания заявки
        },
        replace: true,
        templateUrl: "kit/directives/otp/enter-otp-template.html",
        controller: function ($scope, $element) {
        },
        link: function (scope) {

            scope.model = {

                smsSent: false,

                code: '',

                sendSms: function () {

                    $http.post('rest/app/gen-otp', {}).then(function (rs, status) {
                        scope.model.smsSent = rs.status == 204;
                        if (!scope.model.smsSent) {
                            $error.setError('otp.smsError');
                        }
                    });

                },

                confirm: function () {

                    $http.post('rest/app/send-otp?code=' + scope.model.code, scope.data)
                        .then(function (rs) {
                            if (rs.status == 200) {
                                $declaration.requestId = rs.data.requestNumber;
                                $declaration.goStep('status');
                            }
                        }, function(rs){
                            if (rs.status == 400) {
                                $error.setError('otp.badCode');
                            } else {
                                $error.setError('otp.sendError');
                            }
                        });

                }
            }


        }
    }
}]);
