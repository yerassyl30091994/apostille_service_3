app
    .directive("step", [ "$declaration", '$settings', '$router', function ($declaration, $settings, $router) {
        return {
            scope: {
                name: "@"
            },
            restrict: "E",
            transclude: true,
            replace: true,
            templateUrl: "kit/directives/step/step.html",
            controller: function ($scope, $element, $q) {

            },
            link: function (scope, element, attrs) {

                element.addClass('step-element');

                $router.afterLoading(function(){

                    if( !$declaration.totalSteps ){
                        $declaration.totalSteps  = element.closest('declaration').find('.step-element').length ;
                    }

                    scope.$declaration = $declaration;

                    var stepIndex = 0;
                    _.each(element.closest('declaration').find('.step-element'), function(sibling, index) {
                        if(sibling.id == element.attr('id')) {
                            stepIndex = index;
                        }
                    });

                    scope.step = {
                        scope: scope,
                        element: element,
                        index: stepIndex,
                        id: attrs.id,
                        name: scope.name
                    };

                    $declaration.registerStep(scope.step);
                });

            }
        }
    }]);