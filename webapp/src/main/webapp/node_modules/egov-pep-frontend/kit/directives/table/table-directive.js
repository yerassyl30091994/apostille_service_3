app
    .directive('tableWidget', [function() {
        return {
            templateUrl: "kit/directives/table/table-template.html",
            //templateUrl: "table.html",
            scope: {
                tableData: "=", // данные таблицы
                tableHeaders: "=", // заголовки столбцов
                actionColumn: "=", // последний столбец действий
                dial:'&'
            },
            link: function($scope, $element, $attrs) {

                /*
                 функция построения внутренней структуры данных,
                 которая хранит сами даные, номер строки, отмечена строка или нет
                 */
                var initInternalData = function(data) {
                    $scope.internalData = [];
                    for (var i = 0; i < data.length; i ++) {
                        var rowdata = {
                            rowNum: i,
                            data: rowDataArray(data[i]),
                            isSelected: false
                        };
                        $scope.internalData.push(rowdata);
                    }
                };

                var rowDataArray = function(rowData) {
                    if (_.isArray(rowData)) {
                        return rowData;
                    } else if (_.isObject(rowData)) {
                        return _.values(rowData);
                    } else {
                        throw new Error("Строка данных таблицы должна быть либо объектом либо массивом");
                    }
                }

                /*
                 функция выбора строки
                 */
                var select = function(rowData) {
                    for (var i = 0; i < $scope.internalData.length; i ++) {
                        var curRowData = $scope.internalData[i];
                        curRowData.isSelected = false;
                    }

                    rowData.isSelected = true;
                }

                initInternalData($scope.tableData); // заполнение врутренней структуры

                /*
                 обработка нажатия на кнопку действия
                 */
                $scope.runAction = function(action, rowData) {
                    if (action) {
                        $scope.dial({index: rowData.rowNum});
                        console.debug(action + "->" + JSON.stringify(rowData));
                        if (action === "select") {
                            select(rowData);
                        }
                    }
                }
            }
        };
    }]);

