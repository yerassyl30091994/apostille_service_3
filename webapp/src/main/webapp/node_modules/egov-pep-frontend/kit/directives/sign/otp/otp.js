angular.module("app").directive("egovOtp", [ 'egovOTPservice', '$error', '$rootScope',
    function (egovOTPservice, $error, $rootScope) {
        return {
            restrict: "E",
            scope: {
                callback: "=",
                app:"@",
                parent:"@",
                availability:"=", //Принимает true/false доступность.
                data: "="
            },
            replace: true,
            templateUrl: "kit/directives/sign/otp/otp.html",
            controller: function($scope, $timeout, $session, $declaration){
                var app = egovOTPservice.initApp($scope.app);
                var callback = $scope.callback || function(){};
                var parent = $scope.parent || null;
                $scope.user = {
                    iin:null
                };

                $scope.isPOD = false; //Переменная для показа блока Ввода ИИН, по умолчанию не показываем
                $scope.errorMessage = false; //Сообщение о том что пользователь не зарегистрирован, по умолчанию не показываем
                $scope.regStatus = false; //Переменная для показа блока Ввода ИИН, по умолчанию не показываем

                $scope.$watch('user.iin', function(val){//Следим за ИИН, и обновляем если значение null
                    if(false !== null){
                        $scope.regStatus = false;
                        $scope.errorMessage = false;
                        $scope.phone = null;
                    }
                });

                $scope.checkRegMBC = function() { /*Проверяем зарегистрирован ли пользователь в МБГ*/

                    if($declaration.UI() === "POD"){//Если услугу получают на ПОДе, то пользователь вводит ИИН
                        if($scope.user.iin){ //Не вызываем пока пользователь не введет ИИН
                            egovOTPservice.checkRegMBC(app, $scope.user.iin)
                                .then(function (rs) {
                                    if(rs.data.errCode === 0){ //Проверка успешно выполнено, пользователь зарегистрирован в МБГ
                                        $scope.regStatus = true; //Пользователь зарегистрирован в МБГ, показываем блок отправки кода
                                        $scope.phone = "*******" + rs.data.phone.substr(rs.data.phone.length-4, 4); //На ПОДе показываем только последние 4 цифры
                                        $scope.errorMessage = false; //Пользователь зарегистрирован в МБГ, НЕ показываем сообщение что пользователь не зарегистрирован
                                    }else if (rs.data.errCode == 1) { //У пользователя нет зарегистрированных телефонов
                                        $scope.errorMessage = true; //Пользователь НЕ зарегистрирован в МБГ, показываем сообщение что пользователь не зарегистрирован
                                    }else if (rs.data.errCode == 2) {//Техническая ошибка
                                        $error.setError('egov-otp.sendError'); //При запросе в МБГ произошла ошибка
                                    }
                                });
                        }
                    }else if ($declaration.UI() === "PORTAL") {//Если услугу получают на ПЭПе, то ИИН берем из сессий
                        egovOTPservice.checkRegMBC(app, $session.uin)
                            .then(function (rs) {
                                if(rs.data.errCode === 0){ //Проверка успешно выполнено, пользователь зарегистрирован в МБГ
                                    $scope.regStatus = true; //Пользователь зарегистрирован в МБГ, показываем блок отправки кода
                                    $scope.phone = rs.data.phone; //Номер который зарегистрирован на пользователя
                                }else if (rs.data.errCode == 1) { //У пользователя нет зарегистрированных телефонов
                                    $scope.errorMessage = true;//Пользователь НЕ зарегистрирован в МБГ, показываем сообщение что пользователь не зарегистрирован
                                }else if (rs.data.errCode == 2) {
                                    $error.setError('egov-otp.sendError'); //При запросе в МБГ произошла ошибка
                                }
                            });
                    }
                };

                $scope.newCode = function() {
                    $scope.code = '';
                    $scope.isResend = false;
                    if($declaration.UI() === "POD"){
                        egovOTPservice.newCode(app, $scope.user.iin)
                            .then(function (rs, status) {
                                if(rs.data.errCode === 0){ //Код успешно отправлен пользователю
                                    $scope.isResend = true; //Если тру то показать сообщение "Не пришло СМС?"
                                    $scope.isSMS = true; //Код успешно отправлен, можно показывать блок ввода смс кода
                                }else if (rs.data.errCode === 1) { //У пользователя нет зарегистрированных телефонов
                                    $scope.errorMessage = true;//Пользователь НЕ зарегистрирован в МБГ, показываем сообщение что пользователь не зарегистрирован
                                }else if (rs.data.errCode === 2) {
                                    $error.setError('egov-otp.sendError'); //При отправке СМС произошла ошибка
                                }
                            });
                    }else if ($declaration.UI() === "PORTAL") {//Если услугу получают на ПЭПе, то ИИН берем из сессий
                        egovOTPservice.newCode(app, $session.uin)
                            .then(function (rs, status) {
                                if(rs.data.errCode === 0){ //Код успешно отправлен пользователю
                                    $scope.isResend = true; //Если тру то показать сообщение "Не пришло СМС?"
                                    $scope.isSMS = true; //Код успешно отправлен, можно показывать блок ввода смс кода
                                }else if (rs.data.errCode === 1) { //У пользователя нет зарегистрированных телефонов
                                    $scope.errorMessage = true;//Пользователь НЕ зарегистрирован в МБГ, показываем сообщение что пользователь не зарегистрирован
                                }else if (rs.data.errCode === 2) {
                                    $error.setError('egov-otp.sendError'); //При отправке СМС произошла ошибка
                                }
                            });
                    }
                };
                $scope.sendCode = function(code) {
                    if (egovOTPservice.validateCallBack) {
                        if($declaration.UI() === "POD"){
                            egovOTPservice.validateCallBack($scope.user.iin).then(function () {
                                sendCode(code);
                            });
                        } else {
                            egovOTPservice.validateCallBack().then(function () {
                                sendCode(code);
                            });
                        };
                    } else {
                        sendCode(code);
                    }
                };

                function sendCode(code){
                    var data = null;
                    var iin = $scope.user.iin ? $scope.user.iin : null;  //Для ПОДа, когда вводим ИИН, передаем его как параметр
                    if(app) {
                        data = egovOTPservice.getDefaults($scope.app);
                        for (var attr in $scope.data) { data[attr] = $scope.data[attr]; }
                    }else {
                        data = $scope.data;
                    }
                    egovOTPservice.sendCode(app, code, iin, data, parent, $rootScope.captchaCode).
                    then(function (rs) {
                        $scope.rid = rs.data.requestNumber;
                        callback(rs.data.requestNumber);
                    }, function(rs){
                        if (rs.status == 400) return $error.setError('egov-otp.badCode');
                        $error.setError('egov-otp.sendError');
                    });
                }

                if($declaration.UI() === "POD"){ //Если услугу получают на ПОДе, то показываем блок
                    $scope.isPOD = true; //Мы на ПОДе, поэтому ввод ИИН доступен
                }

                $scope.$watch('availability', function(value) { //следим за доступностью, по кнопке "Подписать, используя СМС-пароль" становится доступен ОТП
                    if (value) {
                        $scope.checkRegMBC(); //Вызов функции для проверки ресгистрации в МБГ
                    }
                });

            },
            link: function ($scope, element, attrs) { }
        };
    }]);
