angular.module("app").directive('vote', [ '$declaration', '$http', '$modal',function ( $declaration, $http, $modal) {

    return {
        scope: {
            keyboard: "@"
        },
        templateUrl: 'kit/directives/vote/vote.html',
        replace: true,
        restrict: "E",
        transclude: true,

        link: function (scope, element, attrs, ctrls) {
			scope.$declaration = $declaration;
			
            scope.isVoted = false;
            // сеттинг состояния при положительном голосовании
            scope.voteUp = function () {
                scope.isVoted = true;
                scope.votedType = 'up';

                scope.voteProps = {
                    "requestNumber" : $declaration.requestId,
                    "uin": $declaration.state.recipientUin,
                    "voteValue": "LIKE"
                };
            };
            scope.$watch(function(){
                return $modal.state;
            }, function(newValue){
                if(!!newValue) scope.isVoted = false;
            });

            // сеттинг состояния при отрицательном голосовании
            scope.voteDown = function () {
                scope.isVoted = true;
                scope.votedType = 'down';

                scope.voteProps = {
                    "requestNumber" : $declaration.requestId,
                    "uin": $declaration.state.recipientUin,
                    "voteValue": "UNLIKE",
                    "comment":$declaration.vote.comment
                };
            };

            // отправка результата голосования на сервер
            scope.sendVoteResult = function () {
                if (scope.votedType == 'down') {
					scope.voteProps.comment = $declaration.vote.comment;
                    scope.commentSent = true;
                }
                $http.post("rest/like/vote", scope.voteProps).then(function (rs) {
                    $declaration.vote.voteState = rs.data.voteState;
                });
            }
        }
    }
}]);
