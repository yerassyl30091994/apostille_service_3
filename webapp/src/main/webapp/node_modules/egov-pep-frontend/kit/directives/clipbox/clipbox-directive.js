angular.module("app").directive('clipbox', ["$parse", function ($parse) {

    return {
        scope: false,
        replace: true,
        restrict: "A",
        controller: function ($scope) {
            this.elems = {};

            this.clip = function (elem) {
                var id = uid();
                this.elems[id] = elem;
            };

            this.unclip = function (id) {
                delete this.elems[id];
            };

            this.update = function () {
                var viewTop = this.box.offset().top;
                var viewBottom = viewTop + this.box.height();

                $scope.inview = $(this.box.find('[clip]')).filter(function () {
                    var elemTop = $(this).offset().top;
                    var elemBottom = elemTop + $(this).height();
                    return elemTop >= viewTop && elemBottom <= viewBottom;
                });
                //console.log('UPDATE' + $scope.inview.length);

                _.each(this.elems, function (elem) {
                    elem.css('visibility', !_.contains($scope.inview, elem[0]) ? 'hidden' : 'visible');
                });
            };

            _.bindAll(this);
        },
        link: function (scope, elem, attrs, controller) {
            controller.box = elem;

            var update = _.throttle(controller.update, 100);

            _.each(['DOMSubtreeModified'], function (event) {
                elem[0].addEventListener(event, update, false);
            });


        }
    }
}]);