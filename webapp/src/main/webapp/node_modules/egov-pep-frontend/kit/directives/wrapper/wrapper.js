app .directive("wrapper", [ '$http', '$session', '$sso', '$document', '$settings','$location','$locales', '$personalCabinet', '$templateCache', '$compile', '$error','$translate', function ($http, $session, $sso, $document, $settings, $location,$locales , $personalCabinet, $templateCache, $compile, $error,$translate) {
    var getTemplateUrl = function () {
        if ($settings.isPod()) return 'kit/directives/wrapper/wrapper-pod.html'
        else return 'kit/directives/wrapper/wrapper-pep.html';
    };

    return {
        scope: true,
        restrict: "E",
        transclude: true,
        replace: true,
        templateUrl: getTemplateUrl(),

        controller: function ($scope) {
            function getPepContent () {
                if ($settings.isContrast()) return $templateCache.get('kit/directives/wrapper/wrapper-pep-contrast.html')
                else return $templateCache.get('kit/directives/wrapper/wrapper-pep.html');
            };
            var localConfig = {
                "chromeNotificationShow":ChromeCheck(),
                "indicatorShow":{
                    "ul":true,
                    "fl":true
                }
            };

            function ChromeCheck() {
                var uAgent = navigator.userAgent.toLowerCase();
                var idx = uAgent.indexOf('chrome');
                if (idx > -1) {
                    var chromeVersion = uAgent.substring(
                        idx + 7, uAgent.indexOf(".", idx)
                    ) * 1;
                    if(chromeVersion > 44) {
                        return true;
                    } else return false;
                } else return false;
            };

            $scope.viewModel = {};
            $scope.findQuery = "";
            $scope.staticConfig = window.staticConfig || localConfig;

            $scope.viewModel.href = function(){ return location.href; };

            $scope.$watch($locales.current,function (){
                if($scope.findQuery)
                    $scope.translateSearchQuery();
            });
            $scope.translateSearchQuery = function () {
                $scope.findQuery = $translate.translate('wrapper.searchExampleText', {});
            }

            $scope.viewModel.pepSearch = function(){
                var locale = ($locales.current() == 'kz') ? 'kk':$locales.current();
                if($scope.findQuery){ location.href = "/cms/"+locale+"/search?query="+$scope.findQuery;  }
            };

            $scope.$watch('$session.uin',function (){
                if($settings.isPep() && (($scope.staticConfig.indicatorShow.fl && $session.individual) || ($scope.staticConfig.indicatorShow.ul && $session.organization))){
                    var indicatorUrl = "";
                    if ($location.host() != 'localhost' && $location.host() != 'local.nitec.kz') {
                        indicatorUrl = '/services/one-inbox/rest-v2/search/indicators';
                    } else {
                        indicatorUrl = '/one-inbox/rest-v2/search/indicators';
                    }
                    $http.get(indicatorUrl).success(function (data){
                        $scope.viewModel.indicators = data.indicators;
                    }).error(function (data){
                            $scope.viewModel.indicators = "";
                        });
                }
            });

        },

        link: function (scope, element, attrs) {
            scope.loginURL = '#';
            scope.containerHistory = false;
            scope.containerNotify = false;
            scope.isUserPopup = false;
             scope.togglePopup = function(){ scope.isUserPopup = !scope.isUserPopup; };
            scope.StartContainerHistory = function () {
                scope.containerHistory = !scope.containerHistory;
                scope.containerNotify = false;

            }
            scope.StartContainerNotify = function () {
                scope.containerNotify = !scope.containerNotify;
                scope.containerHistory = false;

            }
            $document.bind('click', function(event){
                var menu = element.find(".usermenu");
                var notifymenu = element.find("#notifymenu");
                var historymenu = element.find("#historymenu");
                if (notifymenu.find(event.target).length == 0) {scope.containerNotify = false;} else {
                    scope.containerNotify = !scope.containerNotify;
                }
                if (historymenu.find(event.target).length == 0) {scope.containerHistory = false;} else {
                    scope.containerHistory = !scope.containerHistory;
                }
                if (menu.find(event.target).length == 0) {scope.isUserPopup = false} else{
                    scope.isUserPopup = !scope.isUserPopup;
                }//return console.log("menu");


                scope.$digest();

            });
        }
    }
}]);
