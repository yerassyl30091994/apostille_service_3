app.service('$perf', [ '$http', '$q', function ($http, $q) {

    var promise = null;

    function checkSpeed(fileName) {
        var startTime = (new Date()).getTime();
        return $http.get("build/perf/" + fileName + "?n=" + Math.random()).then(function (response) {
            return (new Date()).getTime() - startTime;
        });
    }

    this.estimate = function (size) {
        if (!promise) {
            promise = checkSpeed('dump0kb.txt')
                .then(function (connectSpeed) {
                    return checkSpeed('dump1kb.txt')
                })
                .then(function (speed1k) {
                    return checkSpeed('dump10kb.txt');
                })
                .then(function (speed10k) {
                    return (speed10k/1000) * size / (10*1024);
                });
        }
        return promise;
    };

    return this;
}]);
